---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# mutualinf 

<!-- badges: start -->
[![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0)
<!-- badges: end -->

An R library to calculate and decompose the Mutual Information Index (M) introduced to the social sciences by Theil and Finizza (1971). The M index is a multigroup segregation measure that is highly decomposable, satisfiying both the Strong Unit Decomposability (SUD) and the Strong Group Decomposability (SGD) properties (Frankel and Volij, 2011; Mora and Ruiz-Castillo, 2011). 

The library allows for:

- The computation of the M index, either overall or over subsamples defined by the user.
- The descomposition of the M index into a "between" and a "within" term.
- The identification of the "exclusive contributions" of segregation sources defined either by group or unit characteristics.
- The computation of all the elements that conform the "within" term in the decomposition.
- Fast computation employing more than one CPU core in Mac, Linux, Unix, and BSD systems. This option uses the [`data.table`](https://CRAN.R-project.org/package=data.table) and [`parallel`](https://stat.ethz.ch/R-manual/R-devel/library/parallel/doc/parallel.pdf) libraries (which Windows does not permit to run with more than one CPU core).

## Installation

You can install the stable version of [`mutualinf`] from [CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("mutualinf")
```

and the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("RafaelFuentealbaC/mutualinf")
```

## Functions
The package provides two functions:

```r
?prepare_data 
```
- Which prepares the data to be used by the \code{mutual} function. For more details see `help(prepare_data)`. 

```r
?mutual
```
- Which computes the M index and its decompositions. For more details see `help(mutual)`.

## Usage
The library computes the M Index. Suponga que tiene datos de frecuencias de estudiantes (`nobs`) por combinaciones de escuela (`school`), etnia  (`ethnicity`), nivel socio económico (`csep`) y sexo (`gender`) en un objeto de formato tabular (data.frame, data.table, tibble), que puede contener más columnas. El primer paso es cargar la librería y usar la función prepare_data para declarar la columna que incluye las frecuencias y para formatear los datos para la función `mutual`:

```{r}
library(mutualinf)

DT_Seg_Chile<-prepare_data(data = Data_Chile, vars=c("school","ethnicity","csep","gender","sch_type","rural"), fw="nobs")
```
Por defecto, sin la opción `vars`, `prepare_data` utiliza todas las columnas de la tabla. Es útil usar la opción `vars` con tablas que tienen gran cantidad de columnas que no son necesarias en el análisis. 

Si los datos vienen completamente desagregados, `prepare_data` calculará las frecuencias para todas las celdas de combinación de las variables especificadas:
```{r}
library(mutualinf)

DT_Seg_Chile<-prepare_data(data = Data_Chile_microdata, vars=c("school","ethnicity","csep","gender","sch_type","rural"), vars=('school')
```

In its simplest form, i.e., over one group dimension and one unit dimension:
```{r}
library(mutualinf)

mutual(data = DT_Seg_Chile, group = "csep", unit = "school")
```

Also can be used multiple dimensions in the group and unit analysis:
```{r}
# over multiple group dimensions
mutual(data = DT_Seg_Chile, group = c("csep", "ethnicity"), unit = "school")

# over multiple unit dimensions
mutual(data = DT_Seg_Chile, group = "csep", unit = c("school", "sch_type"))
```

The `by` option allows separate the calculations according to particular dimension or multiple dimensions:
```{r}
mutual(data = DT_Seg_Chile, group = c("csep", "ethnicity"), unit = "school", by = "region")
```

The `within` option allows decompose the total segregation into their between and within terms:
```{r}
# get the segregation that is socio-economic exclusively and then segregation that is ethnic exclusively
# for all socio-economic categories
mutual(data = DT_Seg_Chile, group = c("csep", "ethnicity"), unit = "school", within = "csep")

# get the segregation that is ethnic exclusively and then segregation that is socio-economic exclusively
# for all ethnic categories
mutual(data = DT_Seg_Chile, group = c("csep", "ethnicity"), unit = "school", within = "ethnicity")
```

The `contribution.from` option allows evaluate the exclusive segregating effect of group variables or unit variables into the total segregation. It's an inmediate way of jointly obtaining the relevant results of the two previous decompositions. The `ìnteraction` term refers to an amount of segregation that cannot be attributed to the exclusive segregating effect of characteristics that jointly define the groups (in this case):
```{r}
mutual(data = DT_Seg_Chile, group = c("csep", "ethnicity"), unit = "school", contribution.from = "group_vars")
```

The `components` option allows know the proportions and the local segregation index for all categories of variables of the `within` parameter. The weighted average between `p` and `within` of the `$W_Decomposition` element is equal to the `M_W_csep` term of the `$Total` element:
```{r}
mutual(data = DT_Seg_Chile, group = c("csep", "ethnicity"), unit = "school", within = "csep", components = TRUE)
```

The `cores` option allows use more than one CPU cores in the index compute. This avoids overloading the current work session by distributing calculation tasks in child processs. Compare the differences with the `system.time` function:
```{r}
# Sequentially, using one CPU core:
system.time(mutual(data = DT_Seg_Chile, group = c("csep", "ethnicity", "gender"), unit = c("school", "sch_type", "rural"),
                   within = c("ethnicity", "csep"), contribution.from = "unit_vars", components = TRUE))

# In parallel, using two CPU cores:
system.time(mutual(data = DT_Seg_Chile, group = c("csep", "ethnicity", "gender"), unit = c("school", "sch_type", "rural"),
                   within = c("ethnicity", "csep"), contribution.from = "unit_vars", components = TRUE, cores = 2))

```


## Citation

If you use this library for your research, please cite:

Fuentealba-Chaura, R., Mora, R., Rojas-Mora, J. (2021). mutualinf: a library to calculate and decompose the Mutual Information Index. https://www.github.com/RafaelFuentealbaC/mutualinf


## References

Elbers, B. (2021). A Method for Studying Differences in Segregation Across Time and Space. Sociological Methods & Research. https://doi.org/10.1177/0049124121986204.

Frankel, D. and Volij, O. (2011). Measuring school segregation. Journal of EconomicTheory. 146(1):1-38. https://doi.org/10.1016/j.jet.2010.10.008.

Kullback, S. (1959).Information Theory and Statistics. Wiley Publication in Mathematical Statistics.

Mora, R. and Guinea-Martin, D. (2021). Computing decomposable multigroup indexesof segregation. UC3M Working papers. Economics 31803, Universidad Carlos III de Madrid. Departamento de Economía.

Mora, R. and Ruiz-Castillo, J. (2003). Additively decomposable segregation indexes. The case of gender segregation by occupations and human capital levels in Spain. Journal of Economic Inequality. 1(2):147-179. https://doi.org/10.1023/A:1026198429377.

Mora, R. and Ruiz-Castillo, J. (2011). Entropy-based segregation indices. Sociological Methodology. 41(1):159-194. https://doi.org/10.1111/j.1467-9531.2011.01237.x.

Theil, H. and Finizza, Anthony J. (1971). A note on the measurement of racial integration of schools by means of informational concepts. The Journal of Mathematical Sociology. 1(2):187-193. https://doi.org/10.1080/0022250X.1971.9989795.
