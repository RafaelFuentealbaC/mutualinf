---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# mutualinf 

<!-- badges: start -->
[![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0)
<!-- badges: end -->

An R library to calculate and decompose the Mutual Information Index (M) introduced to the social sciences by Theil and Finizza (1971). The M index is a multigroup segregation measure that is highly decomposable, satisfiying both the Strong Unit Decomposability (SUD) and the Strong Group Decomposability (SGD) properties (Frankel and Volij, 2011; Mora and Ruiz-Castillo, 2011). 

The library allows for:

- The computation of the M index, either overall or over subsamples defined by the user.
- The descomposition of the M index into a "between" and a "within" term.
- The identification of the "exclusive contributions" of segregation sources defined either by group or unit characteristics.
- The computation of all the elements that conform the "within" term in the decomposition.
- Fast computation employing more than one CPU core in Mac, Linux, Unix, and BSD systems. This option uses the [`data.table`](https://CRAN.R-project.org/package=data.table) and [`parallel`](https://stat.ethz.ch/R-manual/R-devel/library/parallel/doc/parallel.pdf) libraries (which Windows does not permit to run with more than one CPU core).

## Installation

You can install the stable version of [`mutualinf`] from [CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("mutualinf")
```

and the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("RafaelFuentealbaC/mutualinf")
```

## Functions
The package provides two functions:

```r
?prepare_data 
```
- Which prepares the data to be used by the \code{mutual} function. For more details see `help(prepare_data)`. 

```r
?mutual
```
- Which computes the M index and its decompositions. For more details see `help(mutual)`.

## Usage
The library computes the M Index. Suponga que tiene datos chilenos para el período 2016-2018 de frecuencias de estudiantes (`nobs`) por combinaciones de, entre otras variables, escuela (`school`), distrito (`commune`), etnia  (`ethnicity`), nivel socio económico (`csep`) y sexo (`gender`) en un objeto de formato tabular (data.frame, data.table, tibble). El primer paso es cargar el paquete y usar la función prepare_data para declarar la columna que incluye las frecuencias y para formatear los datos para la función `mutual`:

```{r}
library(mutualinf)

DT_Seg_Chile_1 <- prepare_data(data = DF_Seg_Chile, vars = "all_vars", fw = "nobs")
```
Si se elige `vars = "all_vars"`, entonces `prepare_data` utiliza todas las columnas de la tabla. Es útil usar la opción `vars` con tablas que tienen gran cantidad de columnas que no son necesarias en el análisis. Por ejemplo: 
```{r}
DT_Seg_Chile_1 <- prepare_data(data = DF_Seg_Chile, vars = c("school","csep"), fw = "nobs")
```
prepara los datos para poder hacer, como veremos más adelante, un análisis de segregación socioeconómica por escuela. Si se desea hacer adicionalmente un análisis de segregación por etnia en las escuelas, la preparación de los datos puede recoger todas las columnas relevantes:
```{r}
DT_Seg_Chile_1 <- prepare_data(data = DF_Seg_Chile, vars = c("school","csep","ethnicity"), fw = "nobs")
```

Si los datos vienen completamente desagregados, `prepare_data` calculará las frecuencias para todas las celdas de combinación de las variables especificadas:
```{r}
DT_Seg_Chile_2 <- prepare_data(data = DF_Seg_Chile, vars = "all_vars")
```

La función \code{mutual} permite calcular el índice M en su forma más simple, es decir, sobre una dimensión grupal de segregación con respecto a una unidad de análisis. Para calcular la segregración socioeconómica por escuelas:
```{r}
mutual(data = DT_Seg_Chile, group = "csep", unit = "school")
```
Para calcular la segregación étnica por escuelas:
```{r}
mutual(data = DT_Seg_Chile, group = "ethnicity", unit = "school")
```
La función \code{mutual} también permite utilizar múltiples dimensiones grupales sobre las que se calcula la segregación, usando las combinaciones de las mismas sobre las unidades de análisis. Por ejemplo:
```{r}
mutual(data = DT_Seg_Chile, group = c("csep", "ethnicity"), unit = "school")
```
calcula la segregación socioeconómica y étnica en las escuelas. Los grupos sobre los que se calcula la segregación automáticamente se definen por todas las combinaciones de nivel socioeconómico y de pertenencia étnica de los estudiantes que se producen en la base de datos. Como podemos ver, la segregación obtenida considerando simultáneamente el nivel socioeconómico y la etnia es mayor que las obtenidas por separado.

De igual manera, se puede realizar el análisis de la segregación utilizando múltiples dimensiones unitarias y/o grupales. Por ejemplo:
```{r}
mutual(data = DT_Seg_Chile, group = c("csep","ethnicity"), unit = c("school", "commune"))
```
calcula la segregación socioeconómica y étnica en las combinaciones de escuelas y distritos. Claramente, el resultado es un nivel de segregación idéntico al obtenido en el caso anterior, pues cada escuela sólo pertenece a un distrito (los distritos son una partición de las escuelas). 

Las variables que definen las unidades pueden no tener una relación jerárquica entre ellas. Por ejemplo, si cambiamos los distritos por la dependencia administrativa de las escuelas (`sch_type`):
```{r}
 mutual(data = DT_Seg_Chile, group = c("csep","ethnicity"), unit = c("school", "sch_type"))
```
calcula la segregación en unidades definidas por las combinaciones de escuelas y tipos de escuelas, de grupos definidos por las combinaciones de nivel socioeconómico y étnia. En las unidades no existe una estructura jerárquica pues hay escuelas que cambián su dependencia administrativa en el período muestral.

La opción \code{by} de la función \code{mutual} permite generar submuestras sobre las que se calcula el nivel de segregación. Los datos utilizados como ilustración incluyen las escuelas de formación primaria de las regiones chilenas del Biobio, La Araucania, y Los Rios. La opción \code{by} permite obtener el nivel de segregación por región en un solo comando:

```{r}
 mutual(data = DT_Seg_Chile, group = "csep", unit = "school", by = "region")
```
El valor del índice reportado es exclusivamente socioeconómico y no considera diferencias por ninguna variable de unidad. El índice de información mutua es estrictamente mayor que cero y, por lo tanto, no puede analizarse sino en relación a otro resultado.


En este caso, la función nos reporta el nombre de cada región acompañado de su respectivo índice, el cual corresponde a la segregación socioeconómica en las escuelas. Podemos ver que la segregación es mayor en la región del Biobio que en las regiones de La Araucania y Los Rios, y a su vez, es mayor que la segregación socioeconómica en las escuelas de las tres regiones conjuntas.

En el siguiente caso se incorpora la pertenencia étnica de los estudiantes:
```{r}
mutual(data = DT_Seg_Chile, group = c("csep", "ethnicity"), unit = "school", by = "region")
```

El resultado corresponde a la segregación socioeconómica y étnica en las escuelas de cada una de las regiones. Podemos ver que la segregación es mayor en la región de La Araucania que en las regiones del Biobio y Los Rios. Por otro lado, la segregación de cada región se mantiene por debajo de la segregación socioeconómica y étnica que resulta en el conjunto de las tres regiones.

## Citation

If you use this library for your research, please cite:

Fuentealba-Chaura, R., Mora, R., Rojas-Mora, J. (2021). mutualinf: a library to calculate and decompose the Mutual Information Index. https://www.github.com/RafaelFuentealbaC/mutualinf


## References

Elbers, B. (2021). A Method for Studying Differences in Segregation Across Time and Space. Sociological Methods & Research. https://doi.org/10.1177/0049124121986204.

Frankel, D. and Volij, O. (2011). Measuring school segregation. Journal of EconomicTheory. 146(1):1-38. https://doi.org/10.1016/j.jet.2010.10.008.

Kullback, S. (1959).Information Theory and Statistics. Wiley Publication in Mathematical Statistics.

Mora, R. and Guinea-Martin, D. (2021). Computing decomposable multigroup indexesof segregation. UC3M Working papers. Economics 31803, Universidad Carlos III de Madrid. Departamento de Economía.

Mora, R. and Ruiz-Castillo, J. (2003). Additively decomposable segregation indexes. The case of gender segregation by occupations and human capital levels in Spain. Journal of Economic Inequality. 1(2):147-179. https://doi.org/10.1023/A:1026198429377.

Mora, R. and Ruiz-Castillo, J. (2011). Entropy-based segregation indices. Sociological Methodology. 41(1):159-194. https://doi.org/10.1111/j.1467-9531.2011.01237.x.

Theil, H. and Finizza, Anthony J. (1971). A note on the measurement of racial integration of schools by means of informational concepts. The Journal of Mathematical Sociology. 1(2):187-193. https://doi.org/10.1080/0022250X.1971.9989795.
